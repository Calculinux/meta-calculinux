#!/bin/sh

echo "PREINIT: Start"

PATH=/sbin:/bin:/usr/sbin:/usr/bin
mount -o remount,rw /

mkdir -p /proc
mkdir -p /sys
mkdir -p /run
mkdir -p /var/run

mount -t proc proc /proc
mount -t sysfs sysfs /sys

[ -z "$CONSOLE" ] && CONSOLE="/dev/console"

OVERLAYS="/etc /root /home /var /usr /opt"

#Grow the overlay partition to fill disk
PARTITION_NAME="$(lsblk -n -r -o NAME -Q 'PARTLABEL =~ "{OVERLAYFS_ETC_LABEL}"')"
PARTITION_SYSFS_PATH="/sys/class/block/$(basename "$PARTITION_NAME")"
PARTITION_DISK="$(lsblk -n -r -o PKNAME -Q 'PARTLABEL =~ "{OVERLAYFS_ETC_LABEL}"')"
PARTITION_NUM="$(lsblk -n -r -o PARTN -Q 'PARTLABEL =~ "{OVERLAYFS_ETC_LABEL}"')"


if growpart --free-percent=10 "$PARTITION_DISK" $PARTITION_NUM; then
  e2fsck -y -f "/dev/$PARTITION_NAME"
  resize2fs "/dev/$PARTITION_NAME"
fi

mkdir -p {OVERLAYFS_ETC_MOUNT_POINT}
if mount -n -t {OVERLAYFS_ETC_FSTYPE} \
    -o {OVERLAYFS_ETC_MOUNT_OPTIONS} \
    "/dev/$PARTITION_NAME" {OVERLAYFS_ETC_MOUNT_POINT}
then
    for overlay in $OVERLAYS; do
        echo ">> Mounting overlay for: $overlay"

        BASE="{OVERLAYFS_ETC_MOUNT_POINT}/overlay/$overlay"
        LOWER_DIR="$BASE/lower"
        UPPER_DIR="$BASE/upper"
        WORK_DIR="$BASE/work"

        mkdir -p $UPPER_DIR
        mkdir -p $WORK_DIR

        if {OVERLAYFS_ETC_EXPOSE_LOWER}; then
            mkdir -p $LOWER_DIR

            # provide read-only access to original /etc content
            mount -o bind,ro $overlay $LOWER_DIR
        fi

        mount -n -t overlay \
              -o upperdir=$UPPER_DIR \
              -o lowerdir=$overlay \
              -o workdir=$WORK_DIR \
              -o index=off,xino=off,redirect_dir=off,metacopy=off \
              $UPPER_DIR $overlay || \
            echo "PREINIT: Mounting $overlay failed!"

    done
else
    echo "PREINIT: Mounting </data> failed!"
fi

echo "PREINIT: done; starting </sbin/init>"
exec {SBIN_INIT_NAME}
