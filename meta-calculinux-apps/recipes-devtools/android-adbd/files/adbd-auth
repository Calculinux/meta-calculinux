#!/bin/sh -e
# Simple password-based auth helper for adbd custom auth.
# Uses /etc/adbd.passwd (plaintext) or /etc/adbd.passwd.md5 (md5 hash).

PASS_PLAIN="/etc/adbd.passwd"
PASS_MD5="/etc/adbd.passwd.md5"

calc_md5() {
	# Busybox md5sum prints "hash  -"; coreutils prints "hash  -" as well.
	printf "%s" "$1" | md5sum | awk '{print $1}'
}

expected=""
if [ -f "$PASS_MD5" ]; then
	expected=$(cat "$PASS_MD5" | tr -d '\n\r')
elif [ -f "$PASS_PLAIN" ]; then
	expected=$(calc_md5 "$(cat "$PASS_PLAIN" | tr -d '\n\r')")
fi

for i in $(seq 1 3); do
	read -p "$(hostname -s)'s password: " PASSWD
	if [ -z "$expected" ] || [ "$(calc_md5 "$PASSWD")" = "$expected" ]; then
		echo "success."
		exit 0
	fi
	echo "password incorrect!"
done

exit 1
