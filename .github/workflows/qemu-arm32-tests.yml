name: QEMU ARM32 Tests

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'meta-calculinux-distro/recipes-core/calculinux-update/**'
      - 'meta-calculinux-distro/recipes-kernel/**'
      - 'meta-calculinux-distro/recipes-core/rauc/**'
      - 'meta-calculinux-distro/recipes-core/opkg/**'
      - 'meta-calculinux-distro/conf/machine/qemu-arm32-test.conf'
      - 'meta-calculinux-distro/recipes-core/image/calculinux-qemu-test-image.bb'
      - 'meta-calculinux-distro/wic/**'
      - '.github/workflows/qemu-arm32-tests.yml'
  workflow_dispatch:

jobs:
  qemu-arm32-test:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout meta-calculinux
        uses: actions/checkout@v4
        with:
          path: meta-calculinux
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            gawk wget git diffstat unzip texinfo gcc build-essential \
            chrpath socat cpio python3 python3-pip python3-pexpect \
            xz-utils debianutils iputils-ping python3-git python3-jinja2 \
            libegl1-mesa libsdl1.2-dev pylint xterm python3-subunit \
            mesa-common-dev zstd liblz4-tool qemu-system-arm \
            gzip file

      - name: Setup KAS
        run: pip3 install --break-system-packages kas

      - name: Build QEMU Test Image
        run: |
          cd meta-calculinux
          kas build kas-qemu-arm32-test.yaml --build-dir ./build
        env:
          SSTATE_DIR: ${{ github.workspace }}/sstate-cache
          DL_DIR: ${{ github.workspace }}/downloads

      - name: Run QEMU (smoke boot)
        run: |
          cd meta-calculinux/build
          timeout 60 runqemu qemu-arm32-test nographic qemuparams="-serial mon:stdio" || true
        continue-on-error: true

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qemu-test-logs
          path: |
            meta-calculinux/build/tmp/log/
            meta-calculinux/build/tmp/work/qemu-arm32-test/*/temp/log.*

      - name: Cache sstate
        uses: actions/cache@v4
        with:
          path: sstate-cache
          key: sstate-qemu-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            sstate-qemu-${{ runner.os }}-
