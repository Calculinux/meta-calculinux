name: PR Comment Artifacts

on:
  workflow_run:
    workflows: ["Build Calculinux Images and Packages"]
    types:
      - completed

permissions:
  pull-requests: write

jobs:
  comment:
    name: Comment artifact links on PR
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get PR number
      id: pr
      uses: actions/github-script@v7
      with:
        script: |
          const allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: ${{ github.event.workflow_run.id }},
          });

          // Get PR number from workflow_run event
          const prNumber = ${{ github.event.workflow_run.pull_requests[0].number || 'null' }};
          if (!prNumber) {
            core.info('No PR number found in workflow_run event');
            return '';
          }

          core.setOutput('number', prNumber);
          return prNumber;

    - name: Comment on PR
      if: steps.pr.outputs.number != ''
      uses: ./.github/actions/comment-artifacts
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
