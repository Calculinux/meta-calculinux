name: Build Calculinux Images and Packages

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      sync_all_packages:
        description: 'Sync all packages (not just newly built ones)'
        required: false
        type: boolean
        default: false

env:
  # Yocto build directories that need persistent storage
  DL_DIR: ${{ github.workspace }}/../yocto-cache/downloads
  SSTATE_DIR: ${{ github.workspace }}/../yocto-cache/sstate-cache
  # Package repository storage
  OPKG_REPO_DIR: /mnt/opkg-repo
  UPDATE_BASE_URL: https://opkg.calculinux.org

permissions:
  contents: write      # Needed for creating releases
  pull-requests: write # Needed for commenting on PRs

# To add a new machine configuration, do something similar to the following:
# 
# matrix:
#   machine: [luckfox-lyra, rpi4]  # Add rpi4 here
#   include:
#     - machine: luckfox-lyra
#       name: "Luckfox Lyra Bundle"
#       kas_file: "kas-luckfox-lyra-bundle.yaml"
#       target: "calculinux-bundle"
#       dockerfile: "Dockerfile.aarch64"
#     - machine: rpi4  # Add new machine config
#       name: "Raspberry Pi 4 Bundle"
#       kas_file: "kas-rpi4-bundle.yaml"
#       target: "calculinux-bundle"
#       dockerfile: "Dockerfile.arm64"
  
jobs:
  build:
    name: Build Yocto Images and Packages
    runs-on: [self-hosted, Linux, X64]
    
    strategy:
      fail-fast: false
      matrix:
        machine: [luckfox-lyra]
        include:
          - machine: luckfox-lyra
            name: "Luckfox Lyra Bundle"
            kas_file: "kas-luckfox-lyra-bundle.yaml"
            target: "calculinux-bundle"
            dockerfile: "Dockerfile.aarch64"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up build environment
      uses: ./.github/actions/setup-build-env
      with:
        dl-dir: ${{ env.DL_DIR }}
        sstate-dir: ${{ env.SSTATE_DIR }}
        opkg-repo-dir: ${{ env.OPKG_REPO_DIR }}

    - name: Determine feed configuration
      id: feed-config
      run: |
        set -euo pipefail
        REF_TYPE="branch"
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          REF_TYPE="tag"
        fi

        TMP_FILE=$(mktemp)
        bash .github/scripts/determine-feed-config.sh "${{ matrix.kas_file }}" "${{ github.ref_name }}" "$REF_TYPE" > "$TMP_FILE"
        cat "$TMP_FILE"
        while IFS='=' read -r key value; do
          [ -z "$key" ] && continue
          echo "$key=$value" >> "$GITHUB_OUTPUT"
        done < "$TMP_FILE"
        rm -f "$TMP_FILE"

    - name: Prepare build configuration
      id: prepare-config
      run: |
        set -euo pipefail
        echo "Preparing build configuration and CI overrides..."

        TMP_FILE=$(mktemp)
        bash .github/scripts/prepare-build-config.sh \
          "${{ matrix.kas_file }}" \
          "${{ steps.feed-config.outputs.distro_codename }}" \
          "${{ steps.feed-config.outputs.feed_subfolder }}" \
          "${{ github.ref_name }}" \
          "${{ steps.feed-config.outputs.is_tagged_release }}" \
          > "$TMP_FILE"

        cat "$TMP_FILE"
        while IFS='=' read -r key value; do
          [ -z "$key" ] && continue
          echo "$key=$value" >> "$GITHUB_OUTPUT"
          if [ "$key" = "distro_version" ]; then
            echo "DISTRO_VERSION=$value" >> "$GITHUB_ENV"
          fi
        done < "$TMP_FILE"
        rm -f "$TMP_FILE"

    - name: Build Yocto image and packages
      run: |
        echo "Building ${{ matrix.name }} using ${{ steps.prepare-config.outputs.kas_override_file }}"
        echo "This will build:"
        echo "  - ${{ matrix.target }} (base image with overlayfs)"
        echo "  - packagegroup-meta-calculinux-apps (IPK packages)"
        echo ""
        echo "All packages install to /usr (standard paths)"
        echo "Runtime: /usr is overlayfs - base in lower layer, user packages in upper layer"

        # Run the build with kas-container using CI override file
        # This file includes the base kas configuration and adds CI-specific overrides
        ./kas-container build "${{ steps.prepare-config.outputs.kas_override_file }}"

    - name: Build SDKs
      if: github.ref_name == 'develop' || github.ref_name == 'main' || startsWith(github.ref, 'refs/tags/')
      env:
        KAS_OVERRIDE_FILE: ${{ steps.prepare-config.outputs.kas_override_file }}
      run: |
        set -euo pipefail
        for sdk_arch in x86_64 aarch64; do
          echo "Building SDK for ${{ matrix.name }} (host architecture: ${sdk_arch})..."
          bash .github/scripts/build-sdk.sh "$sdk_arch" "$KAS_OVERRIDE_FILE"
        done

    - name: Collect build artifacts (images)
      run: |
        bash .github/scripts/collect-images.sh "${{ matrix.machine }}" artifacts

    - name: Collect build artifacts (packages)
      run: |
        bash .github/scripts/collect-packages.sh artifacts

    - name: Collect build artifacts (SDK)
      run: |
        bash .github/scripts/collect-sdk.sh artifacts

    - name: Generate build information
      run: |
        set -euo pipefail
        bash .github/scripts/generate-build-info.sh \
          artifacts/build-info.txt \
          "${{ matrix.name }}" \
          "${{ matrix.machine }}" \
          "${{ matrix.target }}" \
          "${{ matrix.kas_file }}" \
          "${{ matrix.dockerfile }}"

    - name: Persist publish metadata
      run: |
        set -euo pipefail
        mkdir -p artifacts
        cat > artifacts/workflow-metadata.env << EOF
        FEED_NAME=${{ steps.feed-config.outputs.feed_name }}
        SUBFOLDER=${{ steps.feed-config.outputs.subfolder }}
        FEED_SUBFOLDER=${{ steps.feed-config.outputs.feed_subfolder }}
        DISTRO_CODENAME=${{ steps.feed-config.outputs.distro_codename }}
        IS_PUBLISHED_BRANCH=${{ steps.feed-config.outputs.is_published_branch }}
        IS_TAGGED_RELEASE=${{ steps.feed-config.outputs.is_tagged_release }}
        IS_PRERELEASE=${{ steps.feed-config.outputs.is_prerelease }}
        DISTRO_VERSION=${{ steps.prepare-config.outputs.distro_version }}
        EOF

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: calculinux-${{ matrix.machine }}-${{ github.run_number }}
        path: |
          artifacts/calculinux-bundle-${{ matrix.machine }}-*.raucb
          artifacts/calculinux-bundle-${{ matrix.machine }}-*.raucb.sha256
          artifacts/calculinux-image-${{ matrix.machine }}.rootfs-*.wic.gz
          artifacts/calculinux-image-${{ matrix.machine }}.rootfs-*.wic.gz.sha256
          artifacts/uboot-${{ matrix.machine }}-*.bin
          artifacts/u-boot-*initial-env-${{ matrix.machine }}-*
          artifacts/sdk/x86_64/*.sh
          artifacts/sdk/x86_64/*.manifest
          artifacts/sdk/aarch64/*.sh
          artifacts/sdk/aarch64/*.manifest
          artifacts/workflow-metadata.env
        retention-days: 30

    - name: Show disk space after build
      if: always()
      run: |
        echo "Disk space after build:"
        df -h
        
        echo "Cache directory sizes:"
        du -sh $DL_DIR $SSTATE_DIR || true
        
    - name: Cleanup
      if: always()
      run: |
        # Clean up build directory but preserve caches
        rm -rf build/tmp/work/* || true
        
        # Clean up docker containers and images
        docker system prune -f || true
        
        # Remove our custom image to save space
        docker rmi kas-custom:latest || true

  publish:
    name: Publish artifacts and notifications
    needs: build
    if: needs.build.result == 'success'
    runs-on: [self-hosted, Linux, X64]
    strategy:
      fail-fast: false
      matrix:
        machine: [luckfox-lyra]
        include:
          - machine: luckfox-lyra
            name: "Luckfox Lyra Bundle"
            kas_file: "kas-luckfox-lyra-bundle.yaml"
            target: "calculinux-bundle"
            dockerfile: "Dockerfile.aarch64"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: calculinux-${{ matrix.machine }}-${{ github.run_number }}
        path: artifacts

    - name: Load workflow metadata
      id: publish-meta
      run: |
        set -euo pipefail
        META_FILE="artifacts/workflow-metadata.env"
        if [ ! -f "$META_FILE" ]; then
          echo "Metadata file not found: $META_FILE" >&2
          exit 1
        fi
        while IFS='=' read -r key value; do
          [ -z "$key" ] && continue
          echo "$key=$value" >> "$GITHUB_OUTPUT"
          echo "$key=$value" >> "$GITHUB_ENV"
        done < "$META_FILE"

    - name: Publish PR RAUC bundle
      if: github.event_name == 'pull_request'
      run: |
        set -euo pipefail
        bash .github/scripts/publish-pr-bundle.sh \
          "${{ matrix.machine }}" \
          "${{ github.event.pull_request.number }}" \
          "artifacts" \
          "${{ env.OPKG_REPO_DIR }}" \
          "${{ env.UPDATE_BASE_URL }}"

    - name: Sync packages and generate indexes
      if: env.IS_PUBLISHED_BRANCH == 'true'
      uses: ./.github/actions/sync-packages
      with:
        opkg-repo-dir: ${{ env.OPKG_REPO_DIR }}
        feed-name: ${{ env.FEED_NAME }}
        subfolder: ${{ env.SUBFOLDER }}
        artifacts-dir: artifacts
        sync-all: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.sync_all_packages == 'true' && 'true' || 'false' }}

    - name: Publish images to webserver
      if: env.IS_PUBLISHED_BRANCH == 'true'
      run: |
        bash .github/scripts/publish-images.sh \
          "$OPKG_REPO_DIR" \
          "${{ env.FEED_NAME }}" \
          "${{ env.SUBFOLDER }}" \
          "${{ matrix.machine }}" \
          artifacts \
          "${{ env.IS_TAGGED_RELEASE }}" \
          "${{ env.IS_PRERELEASE }}" \
          "${{ github.ref_name }}"

    - name: Generate artifact index
      if: env.IS_PUBLISHED_BRANCH == 'true'
      run: |
        set -euo pipefail
        bash .github/scripts/run-generate-artifact-index.sh \
          "${{ env.OPKG_REPO_DIR }}" \
          "${{ env.FEED_NAME }}" \
          "${{ env.SUBFOLDER }}" \
          "${{ matrix.machine }}" \
          "${{ env.DISTRO_VERSION }}" \
          "${{ github.sha }}" \
          "artifacts" \
          "${{ env.UPDATE_BASE_URL }}"

    - name: Publish SDK to webserver
      if: env.IS_PUBLISHED_BRANCH == 'true'
      run: |
        bash .github/scripts/publish-sdk.sh \
          "$OPKG_REPO_DIR" \
          "${{ env.FEED_NAME }}" \
          "${{ env.SUBFOLDER }}" \
          "${{ matrix.machine }}" \
          artifacts \
          "${{ env.IS_TAGGED_RELEASE }}" \
          "${{ env.IS_PRERELEASE }}" \
          "${{ github.ref_name }}"

    - name: Comment artifact links on PR
      if: github.event_name == 'pull_request'
      uses: ./.github/actions/comment-artifacts
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Create release
      if: env.IS_TAGGED_RELEASE == 'true'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/calculinux-bundle-${{ matrix.machine }}-*.raucb
          artifacts/calculinux-bundle-${{ matrix.machine }}-*.raucb.sha256
          artifacts/calculinux-image-${{ matrix.machine }}.rootfs-*.wic.gz
          artifacts/calculinux-image-${{ matrix.machine }}.rootfs-*.wic.gz.sha256
          artifacts/uboot-${{ matrix.machine }}-*.bin
          artifacts/u-boot-*initial-env-${{ matrix.machine }}-*
          artifacts/sdk/x86_64/*.sh
          artifacts/sdk/x86_64/*.manifest
          artifacts/sdk/aarch64/*.sh
          artifacts/sdk/aarch64/*.manifest
        generate_release_notes: true
        draft: false
        prerelease: ${{ env.IS_PRERELEASE == 'true' }}

    - name: Send Discord notification
      if: env.IS_TAGGED_RELEASE == 'true' && success()
      uses: ./.github/actions/discord-notify
      with:
        webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
        machine: ${{ matrix.machine }}
        feed-name: ${{ env.FEED_NAME }}
        subfolder: ${{ env.SUBFOLDER }}
        is-prerelease: ${{ env.IS_PRERELEASE }}
        tag-name: ${{ github.ref_name }}
        run-number: ${{ github.run_number }}
        release-url: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}
        artifacts-dir: artifacts
        opkg-repo-base: ${{ env.UPDATE_BASE_URL }}

    - name: Show disk space after publish
      if: always()
      run: |
        echo "Disk space after publish job:"
        df -h

    - name: Cleanup
      if: always()
      run: |
        rm -rf artifacts || true
        docker system prune -f || true
